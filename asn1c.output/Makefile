#	Build recipes for ASN.1 encoders and decoders based on the
#	asn1c 'compiler' package. <https://github.com/vlm/asn1c>
#
#	This Makefile assumes that the asn1c package is installed 
#  	and has already be executed against the configuration file:
#  		* epics2camac.asn1
#
#	The strategy is to build a shared object libarary containing the
#	generic asn1c runtime support modules, and build the individual
#	application modules (also produced by the asn1c compiler) to 
#	link against the main module (hand written). This uses a 
#	subset of all available modules, and if a different PDU format
#	is developed or if there are additons to the PDU defined here,
#	then additional asn1c support modules will probably have to 
#	be added.
#	
#	RN - 2025-Jul-13 
# ================================================================
#
CC = gcc

CFLAGS = -I .
CFLAGS += -fPIC
CFLAGS += -D_DEFAULT_SOURCE
CFLAGS += -g

LDFLAGS = -L .

LIBASN1C = libasn1c.so

#
#	libasn1c contents
#
ASN1C_OBJS = \
	asn_codecs_prim.o   \
	pdu_collection.o   \
	NativeEnumerated.o   \
	NativeInteger.o   \
	INTEGER.o   \
	BIT_STRING.o   \
	OCTET_STRING.o   \
	asn_SET_OF.o   \
	constraints.o   \
	constr_CHOICE.o   \
	constr_SEQUENCE.o   \
	constr_SET.o   \
	constr_SET_OF.o   \
	constr_TYPE.o   \
	ber_tlv_length.o   \
	ber_tlv_tag.o   \
	der_encoder.o   \
	ber_decoder.o   \
	per_decoder.o   \
	per_encoder.o   \
	per_opentype.o   \
	per_support.o   \
	xer_decoder.o   \
	xer_encoder.o   \
	xer_support.o

#
#	Project-specific modules generated by asn1c
#
PRJ_OBJS = CamacCycleReplyR.o   \
	CamacCycleReplyW.o   \
	CamacCycleRequestR.o   \
	CamacCycleRequestW.o   \
	CamacReplyFrame.o   \
	CamacRequestFrame.o   \
	BasicCycleRequest.o  \
	PduType.o \
	epics2camacProtocol.o 

DECODER_OBJS = exampleASN1-Decoder.o exampleASN1-Encoder.o

DECODERS = exampleASN1-Decoder exampleASN1-Encoder

.PHONY : clean all asn1

all : $(DECODERS)

exampleASN1-Decoder : exampleASN1-Decoder.o $(PRJ_OBJS) libasn1c.so
	$(CC) -o $@ $< $(LDFLAGS) $(PRJ_OBJS) -lasn1c
 
exampleASN1-Encoder : exampleASN1-Encoder.o $(PRJ_OBJS) libasn1c.so
	$(CC) -o $@ $< $(LDFLAGS) $(PRJ_OBJS) -lasn1c
 
 
libasn1c.so : $(ASN1C_OBJS) 
	$(CC) -shared -o $@ $^

exampleASN1-Encoder.o : exampleASN1-Encoder.c epics2camac.h

exampleASN1-Decoder.o : exampleASN1-Decoder.c epics2camac.h

epics2camacProtocol.o : epics2camacProtocol.c epics2camac.h

.o:.c	
	$(CC) $(CFLAGS) $< -o $@

asn1 :
	asn1c -pdu=all ../epics2camac.asn1

clean :
	rm $(ASN1C_OBJS) 
	rm libasn1c.so
	rm $(PRJ_OBJS) 
	rm $(DECODERS) 


